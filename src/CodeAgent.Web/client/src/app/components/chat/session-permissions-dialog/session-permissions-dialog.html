<h2 mat-dialog-title>
  <mat-icon>security</mat-icon>
  Session Permissions
</h2>

<mat-dialog-content>
  <div class="permissions-container">
    <div class="permissions-intro">
      <mat-icon>info</mat-icon>
      <p>Grant temporary permissions for this chat session only. These permissions will be cleared when you start a new conversation.</p>
    </div>
    
    <!-- File Permissions -->
    <mat-expansion-panel expanded>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>folder</mat-icon>
          File Operations
        </mat-panel-title>
        <mat-panel-description>
          {{ getGrantedCount(filePermissions()) }} of {{ filePermissions().length }} granted
        </mat-panel-description>
      </mat-expansion-panel-header>
      
      <div class="permission-actions">
        <button mat-button (click)="selectAll('file')">Select All</button>
        <button mat-button (click)="deselectAll('file')">Clear All</button>
      </div>
      
      <div class="permission-list">
        @for (permission of filePermissions(); track permission.id) {
          <div class="permission-item" [class.granted]="permission.granted">
            <mat-checkbox 
              [checked]="permission.granted"
              (change)="togglePermission(permission)">
              <div class="permission-content">
                <div class="permission-header">
                  <mat-icon>{{ permission.icon }}</mat-icon>
                  <span class="permission-name">{{ permission.name }}</span>
                  <mat-icon 
                    class="risk-icon" 
                    [color]="getRiskColor(permission.riskLevel)"
                    [matTooltip]="'Risk: ' + permission.riskLevel">
                    {{ getRiskIcon(permission.riskLevel) }}
                  </mat-icon>
                </div>
                <div class="permission-description">{{ permission.description }}</div>
              </div>
            </mat-checkbox>
          </div>
        }
      </div>
    </mat-expansion-panel>
    
    <!-- Git Permissions -->
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>source</mat-icon>
          Git Operations
        </mat-panel-title>
        <mat-panel-description>
          {{ getGrantedCount(gitPermissions()) }} of {{ gitPermissions().length }} granted
        </mat-panel-description>
      </mat-expansion-panel-header>
      
      <div class="permission-actions">
        <button mat-button (click)="selectAll('git')">Select All</button>
        <button mat-button (click)="deselectAll('git')">Clear All</button>
      </div>
      
      <div class="permission-list">
        @for (permission of gitPermissions(); track permission.id) {
          <div class="permission-item" [class.granted]="permission.granted">
            <mat-checkbox 
              [checked]="permission.granted"
              (change)="togglePermission(permission)">
              <div class="permission-content">
                <div class="permission-header">
                  <mat-icon>{{ permission.icon }}</mat-icon>
                  <span class="permission-name">{{ permission.name }}</span>
                  <mat-icon 
                    class="risk-icon" 
                    [color]="getRiskColor(permission.riskLevel)"
                    [matTooltip]="'Risk: ' + permission.riskLevel">
                    {{ getRiskIcon(permission.riskLevel) }}
                  </mat-icon>
                </div>
                <div class="permission-description">{{ permission.description }}</div>
              </div>
            </mat-checkbox>
          </div>
        }
      </div>
    </mat-expansion-panel>
    
    <!-- System Permissions -->
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>computer</mat-icon>
          System Commands
        </mat-panel-title>
        <mat-panel-description>
          {{ getGrantedCount(systemPermissions()) }} of {{ systemPermissions().length }} granted
        </mat-panel-description>
      </mat-expansion-panel-header>
      
      <div class="permission-actions">
        <button mat-button (click)="selectAll('system')">Select All</button>
        <button mat-button (click)="deselectAll('system')">Clear All</button>
      </div>
      
      <div class="permission-list">
        @for (permission of systemPermissions(); track permission.id) {
          <div class="permission-item" [class.granted]="permission.granted">
            <mat-checkbox 
              [checked]="permission.granted"
              (change)="togglePermission(permission)">
              <div class="permission-content">
                <div class="permission-header">
                  <mat-icon>{{ permission.icon }}</mat-icon>
                  <span class="permission-name">{{ permission.name }}</span>
                  <mat-icon 
                    class="risk-icon" 
                    [color]="getRiskColor(permission.riskLevel)"
                    [matTooltip]="'Risk: ' + permission.riskLevel">
                    {{ getRiskIcon(permission.riskLevel) }}
                  </mat-icon>
                </div>
                <div class="permission-description">{{ permission.description }}</div>
              </div>
            </mat-checkbox>
          </div>
        }
      </div>
    </mat-expansion-panel>
    
    <!-- Tool Permissions -->
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>build</mat-icon>
          Tools & Extensions
        </mat-panel-title>
        <mat-panel-description>
          {{ getGrantedCount(toolPermissions()) }} of {{ toolPermissions().length }} granted
        </mat-panel-description>
      </mat-expansion-panel-header>
      
      <div class="permission-actions">
        <button mat-button (click)="selectAll('tool')">Select All</button>
        <button mat-button (click)="deselectAll('tool')">Clear All</button>
      </div>
      
      <div class="permission-list">
        @for (permission of toolPermissions(); track permission.id) {
          <div class="permission-item" [class.granted]="permission.granted">
            <mat-checkbox 
              [checked]="permission.granted"
              (change)="togglePermission(permission)">
              <div class="permission-content">
                <div class="permission-header">
                  <mat-icon>{{ permission.icon }}</mat-icon>
                  <span class="permission-name">{{ permission.name }}</span>
                  <mat-icon 
                    class="risk-icon" 
                    [color]="getRiskColor(permission.riskLevel)"
                    [matTooltip]="'Risk: ' + permission.riskLevel">
                    {{ getRiskIcon(permission.riskLevel) }}
                  </mat-icon>
                </div>
                <div class="permission-description">{{ permission.description }}</div>
              </div>
            </mat-checkbox>
          </div>
        }
      </div>
    </mat-expansion-panel>
    
    <!-- Path Restrictions -->
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>route</mat-icon>
          Path Restrictions (Session Only)
        </mat-panel-title>
        <mat-panel-description>
          {{ sessionPaths().permitted.length }} permitted, {{ sessionPaths().blocked.length }} blocked
        </mat-panel-description>
      </mat-expansion-panel-header>
      
      <div class="path-section">
        <h4>Additional Permitted Paths</h4>
        <div class="add-path">
          <mat-form-field appearance="outline" class="flex-field">
            <mat-label>Add Path</mat-label>
            <input matInput [(ngModel)]="newPermittedPath" 
                   placeholder="/path/to/permit"
                   (keyup.enter)="addPermittedPath()">
          </mat-form-field>
          <button mat-icon-button color="primary" (click)="addPermittedPath()">
            <mat-icon>add_circle</mat-icon>
          </button>
        </div>
        
        <mat-chip-set class="path-chips">
          @for (path of sessionPaths().permitted; track path) {
            <mat-chip-row (removed)="removePermittedPath(path)">
              <mat-icon matChipAvatar>check_circle</mat-icon>
              {{ path }}
              <button matChipRemove>
                <mat-icon>cancel</mat-icon>
              </button>
            </mat-chip-row>
          }
        </mat-chip-set>
      </div>
      
      <mat-divider></mat-divider>
      
      <div class="path-section">
        <h4>Additional Blocked Paths</h4>
        <div class="add-path">
          <mat-form-field appearance="outline" class="flex-field">
            <mat-label>Add Path</mat-label>
            <input matInput [(ngModel)]="newBlockedPath" 
                   placeholder="/path/to/block"
                   (keyup.enter)="addBlockedPath()">
          </mat-form-field>
          <button mat-icon-button color="warn" (click)="addBlockedPath()">
            <mat-icon>block</mat-icon>
          </button>
        </div>
        
        <mat-chip-set class="path-chips">
          @for (path of sessionPaths().blocked; track path) {
            <mat-chip-row (removed)="removeBlockedPath(path)" class="blocked-chip">
              <mat-icon matChipAvatar>block</mat-icon>
              {{ path }}
              <button matChipRemove>
                <mat-icon>cancel</mat-icon>
              </button>
            </mat-chip-row>
          }
        </mat-chip-set>
      </div>
    </mat-expansion-panel>
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="cancel()">Cancel</button>
  <button mat-raised-button color="primary" (click)="applyPermissions()">
    <mat-icon>check</mat-icon>
    Apply Permissions
  </button>
</mat-dialog-actions>