<div class="message" 
     [class.user]="message.role === 'user'" 
     [class.assistant]="message.role === 'assistant'">
  <div class="message-bubble">
    <div class="message-header">
      <mat-icon class="message-avatar">{{ getIcon() }}</mat-icon>
      <span class="message-label">
        @if (message.role === 'user') {
          <span>You</span>
        } @else {
          <span>AI Assistant</span>
          @if (message.metadata?.provider || message.metadata?.model) {
            <span class="provider-info">
              ({{ message.metadata?.provider || '' }}{{ message.metadata?.model ? ' - ' + message.metadata.model : '' }})
            </span>
          }
        }
      </span>
    </div>
    <div class="message-content">
      <!-- Render tool calls using the new tool renderer system -->
      @if (message.toolCalls && message.toolCalls.length > 0) {
        <div class="tool-calls-section">
          @for (toolCall of message.toolCalls; track $index) {
            <app-tool-renderer [toolCall]="toolCall"></app-tool-renderer>
          }
        </div>
      }
      <!-- For assistant messages, try to parse tool calls first -->
      @else if (message.content && message.role === 'assistant') {
        @let parsedCalls = getParsedToolCalls();
        @if (parsedCalls.length > 0) {
          <div class="tool-calls-section">
            @for (toolCall of parsedCalls; track $index) {
              <app-tool-renderer [toolCall]="toolCall"></app-tool-renderer>
            }
          </div>
        } @else {
          <!-- Fallback to plain text for assistant messages without tool calls -->
          <div class="text-content">{{ message.content }}</div>
        }
      }
      <!-- User messages show as plain text -->
      @else if (message.content) {
        <div class="text-content">{{ message.content }}</div>
      }
    </div>
  </div>
  @if (message.timestamp) {
    <div class="message-timestamp">{{ message.timestamp | date:'short' }}</div>
  }
</div>