<div class="provider-config">
  <div class="providers-layout">
    <app-panel 
      title="Configured Providers" 
      icon="dns"
      class="providers-list-panel">
      <div panel-actions>
        <button mat-icon-button color="primary" (click)="addNewProvider()" matTooltip="Add Provider">
          <mat-icon>add</mat-icon>
        </button>
      </div>
      
      <mat-nav-list>
        @for (provider of providers; track provider.id) {
          <app-list-item
            [title]="provider.name"
            [subtitle]="provider.type"
            [icon]="getProviderIcon(provider.type)"
            [selected]="selectedProvider()?.id === provider.id"
            [actions]="[{ 
              id: 'status', 
              icon: provider.enabled ? 'check_circle' : 'cancel', 
              color: provider.enabled ? 'primary' : 'warn',
              label: provider.enabled ? 'Enabled' : 'Disabled'
            }]"
            [showActions]="true"
            (click)="selectProvider(provider)">
          </app-list-item>
        }
      </mat-nav-list>
    </app-panel>
    
    <app-panel 
      title="Provider Details" 
      icon="settings"
      class="provider-details-panel">
      @if (selectedProvider()) {
        <ng-container>
          <div panel-actions>
            @if (!editingProvider()) {
              <button mat-button (click)="startEditing()">
                <mat-icon>edit</mat-icon>
                Edit
              </button>
            } @else {
              <button mat-button (click)="saveProvider()" color="primary">
                <mat-icon>save</mat-icon>
                Save
              </button>
              <button mat-button (click)="cancelEditing()">
                Cancel
              </button>
            }
            <button mat-button color="warn" (click)="deleteProvider()">
              <mat-icon>delete</mat-icon>
              Delete
            </button>
          </div>
        </ng-container>
        
        <form [formGroup]="form" class="provider-form">
          <app-form-field
            label="Provider Name"
            formControlName="name"
            [readonly]="!editingProvider()">
          </app-form-field>
          
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Provider Type</mat-label>
            <mat-select formControlName="type" [disabled]="!editingProvider()">
              <mat-option value="openai">
                <mat-icon>auto_awesome</mat-icon>
                OpenAI
              </mat-option>
              <mat-option value="claude">
                <mat-icon>psychology</mat-icon>
                Claude
              </mat-option>
              <mat-option value="ollama">
                <mat-icon>computer</mat-icon>
                Ollama
              </mat-option>
              <mat-option value="lmstudio">
                <mat-icon>desktop_windows</mat-icon>
                LM Studio
              </mat-option>
            </mat-select>
          </mat-form-field>
          
          @if (form.get('type')?.value === 'openai' || form.get('type')?.value === 'claude') {
            <app-form-field
              label="API Key"
              type="password"
              formControlName="apiKey"
              suffixIcon="key"
              [readonly]="!editingProvider()">
            </app-form-field>
          }
          
          @if (form.get('type')?.value === 'ollama' || form.get('type')?.value === 'lmstudio') {
            <app-form-field
              label="Base URL"
              formControlName="baseUrl"
              hint="API endpoint URL"
              [readonly]="false">
            </app-form-field>
          }
          
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Model</mat-label>
            @if (form.get('type')?.value === 'lmstudio' || editingProvider()) {
              <input matInput formControlName="model" [readonly]="!editingProvider()">
            } @else {
              <mat-select formControlName="model" [disabled]="!editingProvider()">
                @for (model of availableModels[form.get('type')?.value || 'openai']; track model) {
                  <mat-option [value]="model">{{ model }}</mat-option>
                }
              </mat-select>
            }
          </mat-form-field>
          
          <mat-slide-toggle formControlName="enabled" [disabled]="!editingProvider()">
            Provider Enabled
          </mat-slide-toggle>
          
          <div class="test-section">
            <button mat-raised-button (click)="testProvider()">
              <mat-icon>speed</mat-icon>
              Test Connection
            </button>
          </div>
        </form>
        
        @if (supportsModelManagement(selectedProvider())) {
          <app-panel 
            title="Model Management" 
            icon="model_training"
            class="model-management-panel">
            
            <div class="model-search">
              <mat-form-field appearance="outline" class="search-field">
                <mat-label>Search Models</mat-label>
                <input matInput [(ngModel)]="searchQuery" (keyup.enter)="searchModels()">
                <mat-icon matSuffix>search</mat-icon>
              </mat-form-field>
              <button mat-raised-button color="primary" (click)="searchModels()">
                Search
              </button>
              <button mat-button (click)="loadModelsForProvider()">
                <mat-icon>refresh</mat-icon>
                Refresh
              </button>
            </div>
            
            @if (isLoadingModels()) {
              <mat-progress-bar mode="indeterminate"></mat-progress-bar>
            }
            
            @if (installProgress() !== null) {
              <div class="install-progress">
                <p>Installing model...</p>
                <mat-progress-bar mode="determinate" [value]="installProgress()"></mat-progress-bar>
              </div>
            }
            
            <div class="models-tabs">
              <mat-tab-group>
                <mat-tab label="Installed Models">
                  <div class="models-list">
                    @for (model of installedModels(); track model.id) {
                      <div class="model-card">
                        <div class="model-info">
                          <h4>{{ model.name }}</h4>
                          <p>{{ model.description }}</p>
                          <div class="model-meta">
                            @if (model.size) {
                              <span class="size">{{ formatModelSize(model.size) }}</span>
                            }
                            @if (model.capabilities) {
                              <mat-chip-set>
                                @if (model.capabilities.supportsChat) {
                                  <mat-chip>Chat</mat-chip>
                                }
                                @if (model.capabilities.supportsTools) {
                                  <mat-chip>Tools</mat-chip>
                                }
                                @if (model.capabilities.supportsVision) {
                                  <mat-chip>Vision</mat-chip>
                                }
                              </mat-chip-set>
                            }
                          </div>
                        </div>
                        <div class="model-actions">
                          <button mat-button color="primary" (click)="selectModel(model.id)">
                            <mat-icon>check</mat-icon>
                            Select
                          </button>
                          <button mat-button color="warn" (click)="uninstallModel(model)">
                            <mat-icon>delete</mat-icon>
                            Uninstall
                          </button>
                        </div>
                      </div>
                    }
                  </div>
                </mat-tab>
                
                <mat-tab label="Available Models">
                  <div class="models-list">
                    @for (model of availableModelsList(); track model.id) {
                      @if (!model.isInstalled) {
                        <div class="model-card">
                          <div class="model-info">
                            <h4>{{ model.name }}</h4>
                            <p>{{ model.description }}</p>
                            <div class="model-meta">
                              @if (model.size) {
                                <span class="size">{{ formatModelSize(model.size) }}</span>
                              }
                              @if (model.capabilities) {
                                <mat-chip-set>
                                  @if (model.capabilities.supportsChat) {
                                    <mat-chip>Chat</mat-chip>
                                  }
                                  @if (model.capabilities.supportsTools) {
                                    <mat-chip>Tools</mat-chip>
                                  }
                                  @if (model.capabilities.supportsVision) {
                                    <mat-chip>Vision</mat-chip>
                                  }
                                </mat-chip-set>
                              }
                            </div>
                          </div>
                          <div class="model-actions">
                            <button mat-raised-button color="primary" (click)="installModel(model)">
                              <mat-icon>download</mat-icon>
                              Install
                            </button>
                          </div>
                        </div>
                      }
                    }
                  </div>
                </mat-tab>
              </mat-tab-group>
            </div>
          </app-panel>
        }
      } @else {
        <div class="no-selection">
          <mat-icon>touch_app</mat-icon>
          <p>Select a provider to view details</p>
        </div>
      }
    </app-panel>
  </div>
</div>