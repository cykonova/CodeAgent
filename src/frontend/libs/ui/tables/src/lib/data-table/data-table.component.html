<div class="table-container">
  <!-- Search bar -->
  <div class="table-header" *ngIf="showSearch">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>{{ searchPlaceholder }}</mat-label>
      <input matInput (keyup)="applyFilter($event)">
      <mat-icon matPrefix>search</mat-icon>
    </mat-form-field>
  </div>
  
  <!-- Loading spinner -->
  <div class="loading-container" *ngIf="loading">
    <mat-spinner diameter="40"></mat-spinner>
    <span>Loading data...</span>
  </div>
  
  <!-- Data table -->
  <div class="table-wrapper" *ngIf="!loading">
    <table mat-table 
           [dataSource]="dataSource" 
           matSort
           [class.striped]="striped"
           [class.hoverable]="hoverable">
      
      <!-- Checkbox Column -->
      <ng-container matColumnDef="select" *ngIf="selectable">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox (change)="$event ? masterToggle() : null"
                        [checked]="selection.hasValue() && isAllSelected()"
                        [indeterminate]="selection.hasValue() && !isAllSelected()"
                        color="primary">
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row">
          <mat-checkbox (click)="$event.stopPropagation()"
                        (change)="$event ? toggleSelection(row) : null"
                        [checked]="selection.isSelected(row)"
                        color="primary">
          </mat-checkbox>
        </td>
      </ng-container>
      
      <!-- Data Columns -->
      <ng-container *ngFor="let column of columns" [matColumnDef]="column.key">
        <th mat-header-cell 
            *matHeaderCellDef 
            [mat-sort-header]="column.sortable !== false ? column.key : ''"
            [style.width]="column.width"
            [style.text-align]="column.align || 'left'">
          {{ column.label }}
        </th>
        <td mat-cell 
            *matCellDef="let row" 
            [style.text-align]="column.align || 'left'"
            (click)="onRowClick(row)">
          <span [ngSwitch]="column.type">
            <mat-icon *ngSwitchCase="'boolean'" 
                      [color]="getCellValue(row, column) === 'Yes' ? 'primary' : ''">
              {{ getCellValue(row, column) === 'Yes' ? 'check_circle' : 'cancel' }}
            </mat-icon>
            <span *ngSwitchDefault>{{ getCellValue(row, column) }}</span>
          </span>
        </td>
      </ng-container>
      
      <!-- Actions Column -->
      <ng-container matColumnDef="actions" *ngIf="actions.length > 0">
        <th mat-header-cell *matHeaderCellDef style="width: 100px; text-align: center;">
          Actions
        </th>
        <td mat-cell *matCellDef="let row" style="text-align: center;">
          <button mat-icon-button [matMenuTriggerFor]="menu" (click)="$event.stopPropagation()">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item 
                    *ngFor="let action of getVisibleActions(row)"
                    [disabled]="isActionDisabled(action, row)"
                    (click)="action.handler(row)">
              <mat-icon [color]="action.color || ''">{{ action.icon }}</mat-icon>
              <span>{{ action.label }}</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>
      
      <!-- Header Row -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      
      <!-- Data Rows -->
      <tr mat-row 
          *matRowDef="let row; columns: displayedColumns;"
          [class.clickable]="rowClick.observers.length > 0">
      </tr>
      
      <!-- No Data Row -->
      <tr class="mat-row no-data-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">
          <div class="empty-message">
            <mat-icon>inbox</mat-icon>
            <span>{{ emptyMessage }}</span>
          </div>
        </td>
      </tr>
    </table>
  </div>
  
  <!-- Pagination -->
  <mat-paginator *ngIf="showPagination && !loading"
                 [pageSizeOptions]="pageSizeOptions"
                 [pageSize]="pageSizeOptions[0]"
                 showFirstLastButtons>
  </mat-paginator>
</div>