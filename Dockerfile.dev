# Development Dockerfile with hot-reload support
FROM mcr.microsoft.com/dotnet/sdk:8.0

# Install Node.js for Angular development
RUN apt-get update && \
    apt-get install -y curl && \
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs git && \
    rm -rf /var/lib/apt/lists/*

# Install Angular CLI globally
RUN npm install -g @angular/cli@18

WORKDIR /app

# Copy project files
COPY src/ ./src/

# Install Angular dependencies
WORKDIR /app/src/CodeAgent.Web/client
RUN npm install

# Go back to Web project root
WORKDIR /app/src/CodeAgent.Web

# Restore .NET dependencies
RUN dotnet restore

# Environment variables
ENV ASPNETCORE_ENVIRONMENT=Development \
    ASPNETCORE_URLS=http://+:5001 \
    CodeAgent__ProjectDirectory=/workspace

# Expose ports
EXPOSE 5001 4200

# Create startup script
RUN echo '#!/bin/bash\n\
cd /app/src/CodeAgent.Web/client && ng serve --host 0.0.0.0 --port 4200 --poll 2000 &\n\
cd /app/src/CodeAgent.Web && dotnet watch run --urls http://+:5001\n\
' > /app/start.sh && chmod +x /app/start.sh

# Start both Angular and .NET in watch mode
CMD ["/app/start.sh"]