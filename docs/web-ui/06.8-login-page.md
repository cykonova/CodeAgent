# Phase 06.8: Login Page

## Overview
Create the login page component with Material Design form controls, implementing authentication flow and secure credential handling.

## Goals
- Build Material Design login form
- Implement form validation
- Handle authentication flow
- Support remember me functionality
- Provide error feedback

## Implementation

### 1. Login Component Structure

#### Component Files
```
src/app/features/auth/
├── login/
│   ├── login.component.ts
│   ├── login.component.html
│   ├── login.component.scss
│   └── login.component.spec.ts
└── services/
    └── auth.service.ts
```

### 2. Login Component

`src/app/features/auth/login/login.component.ts`:
```typescript
import { Component, OnInit } from '@angular/core';
import { FormBuilder, FormGroup, Validators, ReactiveFormsModule } from '@angular/forms';
import { Router } from '@angular/router';
import { CommonModule } from '@angular/common';
import { MatCardModule } from '@angular/material/card';
import { MatFormFieldModule } from '@angular/material/form-field';
import { MatInputModule } from '@angular/material/input';
import { MatButtonModule } from '@angular/material/button';
import { MatCheckboxModule } from '@angular/material/checkbox';
import { MatIconModule } from '@angular/material/icon';
import { MatProgressSpinnerModule } from '@angular/material/progress-spinner';
import { MatSnackBar, MatSnackBarModule } from '@angular/material/snack-bar';
import { AuthService } from '../services/auth.service';

@Component({
  selector: 'app-login',
  standalone: true,
  imports: [
    CommonModule,
    ReactiveFormsModule,
    MatCardModule,
    MatFormFieldModule,
    MatInputModule,
    MatButtonModule,
    MatCheckboxModule,
    MatIconModule,
    MatProgressSpinnerModule,
    MatSnackBarModule
  ],
  templateUrl: './login.component.html',
  styleUrls: ['./login.component.scss']
})
export class LoginComponent implements OnInit {
  loginForm: FormGroup;
  hidePassword = true;
  isLoading = false;
  returnUrl = '/dashboard';

  constructor(
    private fb: FormBuilder,
    private authService: AuthService,
    private router: Router,
    private snackBar: MatSnackBar
  ) {
    this.loginForm = this.fb.group({
      email: ['', [Validators.required, Validators.email]],
      password: ['', [Validators.required, Validators.minLength(8)]],
      rememberMe: [false]
    });
  }

  ngOnInit(): void {
    // Check if already authenticated
    if (this.authService.isAuthenticated()) {
      this.router.navigate([this.returnUrl]);
    }

    // Restore saved email if remember me was checked
    const savedEmail = localStorage.getItem('rememberedEmail');
    if (savedEmail) {
      this.loginForm.patchValue({
        email: savedEmail,
        rememberMe: true
      });
    }
  }

  onSubmit(): void {
    if (this.loginForm.valid) {
      this.isLoading = true;
      const { email, password, rememberMe } = this.loginForm.value;

      this.authService.login(email, password).subscribe({
        next: (response) => {
          if (rememberMe) {
            localStorage.setItem('rememberedEmail', email);
          } else {
            localStorage.removeItem('rememberedEmail');
          }
          
          this.router.navigate([this.returnUrl]);
        },
        error: (error) => {
          this.isLoading = false;
          this.snackBar.open(
            error.message || 'Invalid credentials',
            'Close',
            { duration: 5000 }
          );
        },
        complete: () => {
          this.isLoading = false;
        }
      });
    }
  }

  getErrorMessage(field: string): string {
    const control = this.loginForm.get(field);
    if (control?.hasError('required')) {
      return `${field.charAt(0).toUpperCase() + field.slice(1)} is required`;
    }
    if (control?.hasError('email')) {
      return 'Please enter a valid email';
    }
    if (control?.hasError('minlength')) {
      return 'Password must be at least 8 characters';
    }
    return '';
  }
}
```

### 3. Login Template

`src/app/features/auth/login/login.component.html`:
```html
<div class="login-container">
  <mat-card class="login-card">
    <mat-card-header>
      <mat-card-title>Sign In</mat-card-title>
      <mat-card-subtitle>Access your Code Agent workspace</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="loginForm" (ngSubmit)="onSubmit()">
        <!-- Email Field -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Email</mat-label>
          <input 
            matInput 
            type="email" 
            formControlName="email"
            placeholder="user@example.com"
            autocomplete="email">
          <mat-icon matPrefix>email</mat-icon>
          <mat-error *ngIf="loginForm.get('email')?.invalid">
            {{ getErrorMessage('email') }}
          </mat-error>
        </mat-form-field>

        <!-- Password Field -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Password</mat-label>
          <input 
            matInput 
            [type]="hidePassword ? 'password' : 'text'" 
            formControlName="password"
            autocomplete="current-password">
          <mat-icon matPrefix>lock</mat-icon>
          <button 
            mat-icon-button 
            matSuffix 
            type="button"
            (click)="hidePassword = !hidePassword"
            [attr.aria-label]="'Hide password'"
            [attr.aria-pressed]="hidePassword">
            <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
          <mat-error *ngIf="loginForm.get('password')?.invalid">
            {{ getErrorMessage('password') }}
          </mat-error>
        </mat-form-field>

        <!-- Remember Me -->
        <div class="form-options">
          <mat-checkbox formControlName="rememberMe" color="primary">
            Remember me
          </mat-checkbox>
          <a href="/forgot-password" class="forgot-password">
            Forgot password?
          </a>
        </div>

        <!-- Submit Button -->
        <button 
          mat-raised-button 
          color="primary" 
          type="submit"
          class="full-width submit-button"
          [disabled]="loginForm.invalid || isLoading">
          <mat-spinner 
            *ngIf="isLoading" 
            diameter="20" 
            class="button-spinner">
          </mat-spinner>
          <span *ngIf="!isLoading">Sign In</span>
        </button>

        <!-- Register Link -->
        <div class="register-link">
          Don't have an account? 
          <a href="/register">Create one</a>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
```

### 4. Login Styles

`src/app/features/auth/login/login.component.scss`:
```scss
.login-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  background-color: var(--color-background);
  padding: var(--spacing-lg);
}

.login-card {
  width: 100%;
  max-width: 400px;
  padding: var(--spacing-lg);

  mat-card-header {
    text-align: center;
    margin-bottom: var(--spacing-xl);

    mat-card-title {
      font-size: 28px;
      font-weight: 500;
      color: var(--color-text-primary);
      margin-bottom: var(--spacing-sm);
    }

    mat-card-subtitle {
      font-size: 14px;
      color: var(--color-text-secondary);
    }
  }
}

.full-width {
  width: 100%;
  margin-bottom: var(--spacing-md);
}

.form-options {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-lg);

  .forgot-password {
    color: var(--color-primary);
    text-decoration: none;
    font-size: 14px;

    &:hover {
      text-decoration: underline;
    }
  }
}

.submit-button {
  height: 48px;
  font-size: 16px;
  margin-bottom: var(--spacing-lg);
  position: relative;

  .button-spinner {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
  }
}

.register-link {
  text-align: center;
  font-size: 14px;
  color: var(--color-text-secondary);

  a {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 500;

    &:hover {
      text-decoration: underline;
    }
  }
}

// Responsive Design
@media (max-width: 600px) {
  .login-container {
    padding: var(--spacing-md);
  }

  .login-card {
    padding: var(--spacing-md);
  }
}

// Dark Mode Support
:host-context(.dark-mode) {
  .login-container {
    background-color: var(--color-background-dark);
  }

  .login-card {
    background-color: var(--color-surface-dark);
  }
}
```

### 5. Authentication Service

`src/app/features/auth/services/auth.service.ts`:
```typescript
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Observable, BehaviorSubject, tap } from 'rxjs';
import { Router } from '@angular/router';

interface LoginResponse {
  token: string;
  user: {
    id: string;
    email: string;
    name: string;
    role: string;
  };
}

@Injectable({
  providedIn: 'root'
})
export class AuthService {
  private apiUrl = '/api/auth';
  private tokenKey = 'auth_token';
  private userSubject = new BehaviorSubject<any>(null);
  public user$ = this.userSubject.asObservable();

  constructor(
    private http: HttpClient,
    private router: Router
  ) {
    this.loadStoredUser();
  }

  login(email: string, password: string): Observable<LoginResponse> {
    return this.http.post<LoginResponse>(`${this.apiUrl}/login`, { email, password })
      .pipe(
        tap(response => {
          this.storeToken(response.token);
          this.userSubject.next(response.user);
        })
      );
  }

  logout(): void {
    localStorage.removeItem(this.tokenKey);
    this.userSubject.next(null);
    this.router.navigate(['/login']);
  }

  isAuthenticated(): boolean {
    return !!this.getToken();
  }

  getToken(): string | null {
    return localStorage.getItem(this.tokenKey);
  }

  private storeToken(token: string): void {
    localStorage.setItem(this.tokenKey, token);
  }

  private loadStoredUser(): void {
    const token = this.getToken();
    if (token) {
      // Decode JWT token to get user info
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        this.userSubject.next(payload.user);
      } catch (error) {
        this.logout();
      }
    }
  }
}
```

### 6. Route Configuration

Add to routing module:
```typescript
import { LoginComponent } from './features/auth/login/login.component';

const routes: Routes = [
  {
    path: 'login',
    component: LoginComponent
  },
  // ... other routes
];
```

### 7. Auth Guard

`src/app/core/guards/auth.guard.ts`:
```typescript
import { Injectable } from '@angular/core';
import { Router, CanActivate, ActivatedRouteSnapshot, RouterStateSnapshot } from '@angular/router';
import { AuthService } from '../../features/auth/services/auth.service';

@Injectable({
  providedIn: 'root'
})
export class AuthGuard implements CanActivate {
  constructor(
    private router: Router,
    private authService: AuthService
  ) {}

  canActivate(
    route: ActivatedRouteSnapshot,
    state: RouterStateSnapshot
  ): boolean {
    if (this.authService.isAuthenticated()) {
      return true;
    }

    this.router.navigate(['/login'], { 
      queryParams: { returnUrl: state.url }
    });
    return false;
  }
}
```

## Testing

### Unit Tests
```typescript
describe('LoginComponent', () => {
  let component: LoginComponent;
  let authService: jasmine.SpyObj<AuthService>;

  beforeEach(() => {
    const spy = jasmine.createSpyObj('AuthService', ['login', 'isAuthenticated']);
    
    TestBed.configureTestingModule({
      imports: [LoginComponent],
      providers: [
        { provide: AuthService, useValue: spy }
      ]
    });
    
    authService = TestBed.inject(AuthService) as jasmine.SpyObj<AuthService>;
  });

  it('should validate email format', () => {
    const emailControl = component.loginForm.get('email');
    emailControl?.setValue('invalid-email');
    expect(emailControl?.hasError('email')).toBeTruthy();
  });

  it('should submit valid form', () => {
    component.loginForm.setValue({
      email: 'test@example.com',
      password: 'password123',
      rememberMe: false
    });
    
    authService.login.and.returnValue(of({ token: 'test', user: {} }));
    component.onSubmit();
    
    expect(authService.login).toHaveBeenCalledWith('test@example.com', 'password123');
  });
});
```

## Accessibility

- Proper ARIA labels for form controls
- Keyboard navigation support
- Screen reader friendly error messages
- High contrast mode support
- Focus management

## Security Considerations

- Secure password field with visibility toggle
- HTTPS only for authentication
- JWT token storage in localStorage with expiration
- CSRF protection headers
- Rate limiting on backend
- Input sanitization

## Success Metrics

- [ ] Form validation working correctly
- [ ] Authentication flow complete
- [ ] Remember me functionality working
- [ ] Error handling implemented
- [ ] Responsive design on all devices
- [ ] Accessibility standards met
- [ ] Unit tests passing

## Next Steps
- Implement registration page (Phase 06.9)
- Add OAuth providers
- Implement password reset flow
- Add two-factor authentication